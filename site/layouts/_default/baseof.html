<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>{{ block "title" . }}{{ .Site.Title }}{{ end }}</title>
  {{ $style := resources.Get "css/style.css" | minify | fingerprint }}
  <link rel="stylesheet" href="{{ $style.Permalink }}" integrity="{{ $style.Data.Integrity }}">
</head>
<body data-baseurl="{{ .Site.BaseURL }}">
  <div class="page">
    <aside class="sidebar">
      <div>
        <div class="brand">Хроники Кастрюли</div>
        <div class="sub">The Pot Chronicles</div>
      </div>
      <nav class="sidebar-nav">
        <a href="{{ .Site.BaseURL }}">Главная</a>
        <a href="{{ .Site.BaseURL }}archives/">По датам</a>
        <a href="{{ .Site.BaseURL }}tags/">Теги</a>
      </nav>
      <div class="search-box">
        <label for="search-input">Поиск</label>
        <input id="search-input" type="search" placeholder="Введите название или тег">
        <div id="search-results" class="search-results"></div>
      </div>
    </aside>
    <div class="content">
      {{ partial "header.html" . }}
      <main class="main">
        {{ block "main" . }}{{ end }}
      </main>
      <footer class="site-footer">
        &copy; {{ now.Format "2006" }} {{ .Site.Title }}
      </footer>
    </div>
  </div>
  <script src="https://cdn.jsdelivr.net/npm/fuse.js@6.6.2"></script>
  <script>
    (() => {
      const input = document.getElementById('search-input');
      const resultsBox = document.getElementById('search-results');
      if (!input || !resultsBox) return;

      const base = document.body.dataset.baseurl || '/';
      const indexUrl = new URL('index.json', base).toString();
      let fuse = null;

      const render = (items) => {
        if (!items.length) {
          resultsBox.innerHTML = '<div class="search-empty">Ничего не найдено</div>';
          return;
        }
        resultsBox.innerHTML = items.slice(0, 6).map(res => {
          const d = res.item || res;
          const cats = (d.categories || []).join(', ');
          return `<a class="search-item" href="${d.url}">
              <div class="search-title">${d.title}</div>
              ${cats ? `<div class="search-meta">${cats}</div>` : ''}
            </a>`;
        }).join('');
      };

      fetch(indexUrl)
        .then(r => r.json())
        .then(json => {
          fuse = new Fuse(json, {
            keys: ['title', 'categories', 'tags', 'summary'],
            includeScore: true,
            threshold: 0.4,
          });
        })
        .catch(() => {
          resultsBox.innerHTML = '<div class="search-empty">Не удалось загрузить индекс</div>';
        });

      input.addEventListener('input', (e) => {
        const q = e.target.value.trim();
        if (!q || !fuse) {
          resultsBox.innerHTML = '';
          return;
        }
        const res = fuse.search(q);
        render(res);
      });
    })();
  </script>
</body>
</html>
